version: 1.0
runtime: nodejs22 # App Runner 지원 버전에 맞춰 선택 (20/22 지원 여부 확인 필요)
build:
  commands:
    build:
      # 1. 의존성 설치
      - yarn install --frozen-lockfile
      # 2. Prisma 클라이언트 생성
      - npx prisma generate
      # 3. NestJS 빌드
      - yarn build
run:
  # 실행 명령어 (Dockerfile의 CMD와 동일)
  command: node dist/main.js
  network:
    # Dockerfile의 EXPOSE 3005와 일치시켜야 함
    port: 3005
  env:
    - name: NODE_ENV
      value: production
  secrets:
    - name: DATABASE_URL
      value-from: 'arn:aws:secretsmanager:ap-southeast-1:526681945991:secret:sparklit-ynuzPA:DATABASE_URL::'
    - name: HASH_KEY
      value-from: 'arn:aws:secretsmanager:ap-southeast-1:526681945991:secret:sparklit-ynuzPA:HASH_KEY::'
    - name: GEMINI_API_KEY
      value-from: 'arn:aws:secretsmanager:ap-southeast-1:526681945991:secret:sparklit-ynuzPA:GEMINI_API_KEY::'
    - name: GOOGLE_PLACES_API_KEY
      value-from: 'arn:aws:secretsmanager:ap-southeast-1:526681945991:secret:sparklit-ynuzPA:GOOGLE_PLACES_API_KEY::'
    - name: AWS_S3_ACCESS_KEY_ID
      value-from: 'arn:aws:secretsmanager:ap-southeast-1:526681945991:secret:sparklit-ynuzPA:AWS_S3_ACCESS_KEY_ID::'
    - name: AWS_S3_SECRET_ACCESS_KEY
      value-from: 'arn:aws:secretsmanager:ap-southeast-1:526681945991:secret:sparklit-ynuzPA:AWS_S3_SECRET_ACCESS_KEY::'
    - name: MJ_API_KEY
      value-from: 'arn:aws:secretsmanager:ap-southeast-1:526681945991:secret:sparklit-ynuzPA:MJ_API_KEY::'
    - name: MJ_SECRET_KEY
      value-from: 'arn:aws:secretsmanager:ap-southeast-1:526681945991:secret:sparklit-ynuzPA:MJ_SECRET_KEY::'
